import puck.javaAG.mutable.JavaAccessGraph;
import puck.javaAG.mutable.nodeKind.JavaNodeKind;
import puck.javaAG.mutable.JavaNamedType;
import puck.javaAG.mutable.MethodType;
import puck.graph.mutable.AGNode;
import puck.graph.mutable.NamedType;
import puck.graph.mutable.Tuple;
import puck.graph.mutable.Type;
import puck.graph.AGBuildingError;


aspect AccessGraphFactory {

	public interface LoadingListener {
		public void update(double loading);
	}	

	public JavaAccessGraph Program.buildAccessGraph(Map<String,Collection<BodyDecl>> stringsRequest, LoadingListener ll){

		JavaAccessGraph accessGraph = new JavaAccessGraph();

		accessGraph.program_$eq(this);

		if(stringsRequest != null){
			for (java.util.Map.Entry<String, Collection<BodyDecl>>  entry : allStringUses(stringsRequest).entrySet()) {
				accessGraph.addStringLiteral(entry.getKey(), entry.getValue());
			}
		}

		if(ll == null)
			silentBuild(accessGraph);
		else
			verboseBuild(accessGraph, ll);

		return accessGraph;
	}

	private void Program.silentBuild(JavaAccessGraph accessGraph){
		List<CompilationUnit> compUnitList = getCompilationUnitList();
		for (CompilationUnit cu : compUnitList) {
			if (!cu.buildAccessGraph_CU(accessGraph))				
				break;
		}
	}

	private void Program.verboseBuild(JavaAccessGraph accessGraph, LoadingListener ll){
		List<CompilationUnit> compUnitList = getCompilationUnitList();
		double nchild = compUnitList.getNumChild();
		double d = 0.0;
		for (CompilationUnit cu : compUnitList) {
			if (!cu.buildAccessGraph_CU(accessGraph))				
				break;
			d++;
			ll.update(d/nchild);
		}
		ll.update(1);
	}


	public AGNode<JavaNodeKind> ASTNode.buildAG(JavaAccessGraph accessGraph){
		// for(int i=0; i< getNumChild(); i++){
		// 	getChild(i).buildAG(accessGraph);
		// }
		// return null;
		throw new AGBuildingError(this.getClass()+" does not know how to create an AccessGraph");
	}

	public boolean CompilationUnit.buildAccessGraph_CU(JavaAccessGraph accessGraph){
		if(pathName() != null){
			AGNode<JavaNodeKind> packageNode = accessGraph.addPackage(getPackageDecl(), true);

			for (TypeDecl td : getTypeDecls()){
				packageNode.contentAdd(td.buildAG(accessGraph), true);
			}
			return true;
		}
		else{
			if(!getPackageDecl().equals("@primitive"))
				System.err.println(getPackageDecl()+" : pathName = null");
			return false;
		}
	}

	public AGNode<JavaNodeKind> MemberClassDecl.buildAG(JavaAccessGraph accessGraph){
		return typeDecl().buildAG(accessGraph);
	}

	public AGNode<JavaNodeKind> FieldDecl.buildAG(JavaAccessGraph accessGraph, AGNode<JavaNodeKind> usedNode){
		AGNode<JavaNodeKind> agNode = buildAGNode(accessGraph);
		
		//AST.List<VariableDecl> vdl = getVariableDeclList();
		for (VariableDecl vd : getVariableDeclList()) {
			AGNode<JavaNodeKind> vdNode = vd.buildAGNode(accessGraph);
			vdNode.userAdd(usedNode, true); //TODO check why (?!)
		}

		return agNode;
	}


	public AGNode<JavaNodeKind> FieldDeclaration.buildAG(JavaAccessGraph accessGraph){
		AGNode<JavaNodeKind> agNode = buildAGNode(accessGraph);

		for (Access user : uses()) {
			AGNode<JavaNodeKind> agUser = user.hostBodyDecl().buildAGNode(accessGraph);
			agNode.userAdd(agUser, true);
		}

		return agNode;
	}



	public AGNode<JavaNodeKind> FieldDecl.buildAG(JavaAccessGraph accessGraph){
		AGNode<JavaNodeKind> agNode = buildAGNode(accessGraph);
		for (VariableDecl vd : getVariableDeclList()) {
			vd.buildAGNode(accessGraph);
		}
		return agNode;
	}

	public AGNode<JavaNodeKind> Expr.buildDominantUserAGNode(JavaAccessGraph accessGraph){
		throw new AGBuildingError("Cannot get a primary user from the qualifier : " + this +
                " ("+this.getClass()+")");
	}


	public AGNode<JavaNodeKind> VarAccess.buildDominantUserAGNode(JavaAccessGraph accessGraph){
      return decl().buildAGNode(accessGraph);
  	}

  	//in case of static call
  	public AGNode<JavaNodeKind> TypeAccess.buildDominantUserAGNode(JavaAccessGraph accessGraph){
      return decl().buildAGNode(accessGraph);
  	}

  	public AGNode<JavaNodeKind> MethodAccess.buildDominantUserAGNode(JavaAccessGraph accessGraph){
      return decl().buildAGNode(accessGraph);
  	}
  	 public AGNode<JavaNodeKind> ArrayAccess.buildDominantUserAGNode(JavaAccessGraph accessGraph){
      //System.out.println("ArrayAccess.buildDominantUserAGNode " +this.toString());
      return varDecl().buildAGNode(accessGraph);
  }

  	public AGNode<JavaNodeKind> MethodDecl.buildAG(JavaAccessGraph accessGraph){
        AGNode<JavaNodeKind> agNode = buildAGNode(accessGraph);

        AGNode<JavaNodeKind> hostTypeAGNode = hostType().buildAGNode(accessGraph);

        for (Access user : uses()) {
            AGNode<JavaNodeKind> agUser = user.hostBodyDecl().buildAGNode(accessGraph);
            agNode.userAdd(agUser, true);

            //if user.getQualifier == null
            //then the method is called from within the hosting class (implicit "this" qualifier)
            AGNode<JavaNodeKind> agDominantUser;
            if(user.getQualifier()==null
                    || user.getQualifier().isThisAccess()
                    || user.getQualifier().isSuperAccess()) {
                //agDominantUser = user.hostBodyDecl().buildAGNode(accessGraph);
                agDominantUser =  user.hostType().buildAGNode(accessGraph);
                hostTypeAGNode.users().$plus$eq(agDominantUser, true);
            }
            else{
                Expr qualifier = user.getQualifier();
                if(qualifier.isArrayAccess()){
                    /*System.out.println("exploring uses of "+this.getDesambiguateFullName());
                	System.out.println(qualifier +" isArrayAccess nextAccess: " +qualifier.nextAccess());*/

                    //TODO check if always works !!!
                    // in StackArray exemple
                    // expression  stacks[0].push( i )
                    // ArrayAccess is [0]
                    //parentDot is [0].push(i)
                    //parentDot.parentDot is  stacks[0].push( i ) ...
                    AbstractDot d = qualifier.parentDot().parentDot();
                    d.rotateRight();
                    /*System.out.println("leftSide of ancestor dot rotated right : " + d.leftSide());
                    System.out.println(" parent is : " + qualifier.parent);
                    System.out.println(" parentDot is : " + qualifier.parentDot());
                    System.out.println(" parentDot().parentDot is : " + qualifier.parentDot().parentDot());*/

                    qualifier = d.leftSide();
                }

                agDominantUser = qualifier.buildDominantUserAGNode(accessGraph);
            }
            accessGraph.addUsesDependency(agDominantUser, hostTypeAGNode,
                    agUser, agNode);
            //System.out.print("uses( "+agUser+ ", "+agNode+")");
            //System.out.println(" = uses( "+user+ ", "+this+")");
            //System.out.println(" dominated by : uses ("+agDominantUser + ", "+ hostTypeAGNode+")");
            //System.out.println(" = uses( "+user.hostType()+ ", "+ hostType()+")");
        }

        return agNode;
    }

	public AGNode<JavaNodeKind> ConstructorDecl.buildAG(JavaAccessGraph accessGraph){
		AGNode<JavaNodeKind> agNode = buildAGNode(accessGraph);

        AGNode<JavaNodeKind> hostTypeAGNode = hostType().buildAGNode(accessGraph);

        for (Access user : uses()) {
            AGNode<JavaNodeKind> agUser = user.hostBodyDecl().buildAGNode(accessGraph);

            agNode.userAdd(agUser, true);

        //    MethodDecl.addDependantUse(accessGraph, user, agNode, hostTypeAGNode);
            accessGraph.addUsesDependency(agUser, hostTypeAGNode,
                    agUser, agNode);

        }
		return agNode;
	}

	public AGNode<JavaNodeKind> Variable.buildAGNode(JavaAccessGraph accessGraph);
	

	public AGNode<JavaNodeKind> InstanceInitializer.buildAG(JavaAccessGraph accessGraph){
		System.err.println("TODO !! InstanceInitializer.buildAG");
		return buildAGNode(accessGraph);
	}

	public AGNode<JavaNodeKind> StaticInitializer.buildAG(JavaAccessGraph accessGraph){
		System.err.println("TODO !! StaticInitializer.buildAG");
		return buildAGNode(accessGraph);
	}

	public AGNode<JavaNodeKind> TypeDecl.buildAG(JavaAccessGraph accessGraph){
		
		AGNode<JavaNodeKind> tdNode = buildAG_TypeDecl(accessGraph);

		for (Access use : uses()) {
			BodyDecl hostBodyDecl = use.hostBodyDecl();
            if (hostBodyDecl != null) {
                AGNode<JavaNodeKind> userNode = hostBodyDecl.buildAGNode(accessGraph);
                tdNode.userAdd(userNode, true);
            }
		}

		for (BodyDecl bd : getBodyDeclList()) {

			AGNode<JavaNodeKind> bdNode = bd.buildAG(accessGraph);
			//if bd is an initializer (static or not), 
			//the corresponding AGNode is tdNode !!
			if(bdNode!=tdNode)
				tdNode.contentAdd(bdNode, true);
		}

		return tdNode;
	}

    static void TypeDecl.addImplements(JavaAccessGraph accessGraph, 
    	AGNode<JavaNodeKind> sub, AST.List<Access> implementList){

    	for(Access a : implementList){
    		
    		if(!((TypeDeclared)a).getTypeDecl().isFromStdLib()){
    			sub.superTypes_$plus$eq(a.buildAGNode(accessGraph), true);
			}

			a.addExtendsAndImplementsUses(accessGraph, sub);
    	}
	}

	AGNode<JavaNodeKind> TypeDecl.buildAG_TypeDecl(JavaAccessGraph accessGraph){
		throw new AGBuildingError(this.getClass() + " : expected ClassDecl or InterfaceDecl");
	}

	AGNode<JavaNodeKind> ClassDecl.buildAG_TypeDecl(JavaAccessGraph accessGraph){
		AGNode<JavaNodeKind> agNode = buildAGNode(accessGraph);

		if (hasSuperclass() && !"java.lang.Object".equals(superclass().fullName())){
			
			if(!superclass().isFromStdLib())
				agNode.superTypes_$plus$eq(getSuperClassAccess().buildAGNode(accessGraph), true);

			getSuperClassAccess().addExtendsAndImplementsUses(accessGraph, agNode);
		}

		TypeDecl.addImplements(accessGraph, agNode, getImplementss());

		return agNode;
	}

	AGNode<JavaNodeKind> InterfaceDecl.buildAG_TypeDecl(JavaAccessGraph accessGraph){
		AGNode<JavaNodeKind> agNode = buildAGNode(accessGraph);
		
		TypeDecl.addImplements(accessGraph, agNode, getSuperInterfaceIdList());

		return agNode;
	}


	void Access.addExtendsAndImplementsUses(JavaAccessGraph accessGraph, AGNode<JavaNodeKind> sub){
		throw new AGBuildingError(this.getClass() + " : expected TypeAccess or ParTypeAccess");
	}


	void TypeAccess.addExtendsAndImplementsUses(JavaAccessGraph accessGraph, AGNode<JavaNodeKind> sub){
		if(!decl().isFromStdLib()){
			AGNode<JavaNodeKind> sn = decl().buildAGNode(accessGraph);
			sn.userAdd(sub, true);
		}
	}

	void ParTypeAccess.addExtendsAndImplementsUses(JavaAccessGraph accessGraph, AGNode<JavaNodeKind> sub){
		getTypeAccess().addExtendsAndImplementsUses(accessGraph, sub);
		for(Access typeArg : getTypeArguments()){
			typeArg.addExtendsAndImplementsUses(accessGraph, sub);
		}
	}


	public JavaNodeKind TypeDecl.getAGNodeKind(){
		throw new AGBuildingError(this.getClass()+" : Unkown nodekind");
	}

	public JavaNodeKind ClassDecl.getAGNodeKind(){
		return JavaNodeKind.classKind();
	}

	public JavaNodeKind InterfaceDecl.getAGNodeKind(){
		return JavaNodeKind.interfaceKind();
	}

	public AGNode<JavaNodeKind> ASTNode.buildAGNode(JavaAccessGraph accessGraph){
		throw new AGBuildingError(this.getClass()+" does not know how to create an AG Node");
	}



	public void TypeDecl.registerDecl(JavaAccessGraph accessGraph, AGNode<JavaNodeKind> agnode){
      throw new Error(this.getClass() +" does not know how to register itself");
  	}

  	public void ClassDecl.registerDecl(JavaAccessGraph accessGraph, AGNode<JavaNodeKind> agnode){
        accessGraph.registerDecl(agnode, this);
    }

    public void InterfaceDecl.registerDecl(JavaAccessGraph accessGraph, AGNode<JavaNodeKind> agnode){
        accessGraph.registerDecl(agnode, this);
    }

	public AGNode<JavaNodeKind> TypeDecl.buildAGNode(JavaAccessGraph accessGraph){
      AGNode<JavaNodeKind> node;
      if(isFromStdLib())
          node = accessGraph.addApiTypeNode(this, false);
      else
          node = accessGraph.addNode(fullName(), name(), getAGNodeKind());

      registerDecl(accessGraph, node);
      return node;
  	}

	

	public AGNode<JavaNodeKind> TypeAccess.buildAGNode(JavaAccessGraph accessGraph){
		return decl().buildAGNode(accessGraph);
	}

	public AGNode<JavaNodeKind> ParTypeAccess.buildAGNode(JavaAccessGraph accessGraph){
		return accessGraph.addNode(fullName(), name(), 
				getTypeDecl().getAGNodeKind());
	}
	

	/*public AGNode BodyDecl.buildAGNode(JavaAccessGraph accessGraph){
		System.out.println("Bodydecl or subclass");
		return super.buildAGNode(accessGraph);
	}*/

	public AGNode<JavaNodeKind> FieldDeclaration.buildAGNode(JavaAccessGraph accessGraph){
		JavaNamedType type = new JavaNamedType(type().buildAGNode(accessGraph));
		AGNode<JavaNodeKind> node = accessGraph.addNode(fullName(), name(),
				JavaNodeKind.field(type));

        accessGraph.registerDecl(node, this);
        return node;
	}

	public AGNode<JavaNodeKind> VoidType.buildAGNode(JavaAccessGraph accessGraph){
		AGNode<JavaNodeKind> node = accessGraph.apply(fullName());
      //TODO FIX !!
      //accessGraph.registerDecl(node, this);
      return node;
	}
	public AGNode<JavaNodeKind> PrimitiveType.buildAGNode(JavaAccessGraph accessGraph){
		AGNode<JavaNodeKind> node =  accessGraph.apply(fullName());

      	accessGraph.registerDecl(node, this);

      	return node;

	}

	/*public AGNode FieldDecl.buildAGNode(JavaAccessGraph accessGraph){
		AGNode agTypeNode = getTypeAccess().buildAGNode(accessGraph);

		return accessGraph.addNode(fullName(), name(), 
				JavaNodeKind.field(new NamedType(agTypeNode)));
	}*/


	static Tuple ASTNode.astParamsToAGType(JavaAccessGraph accessGraph, Callable c){
		ArrayList<Type> tparams = new ArrayList<Type>();
		for(ParameterDeclaration pdecl: c.getParameterList()){
			AGNode<JavaNodeKind> agTypeNode = pdecl.getTypeAccess().buildAGNode(accessGraph);
			tparams.add(new NamedType<JavaNodeKind>(agTypeNode));
		}
		return new Tuple(scala.collection.JavaConversions.asScalaBuffer(tparams).toList());
	}


	public AGNode<JavaNodeKind> MethodDecl.buildAGNode(JavaAccessGraph accessGraph){
		
      MethodType methodAGType = new MethodType(ASTNode.astParamsToAGType(accessGraph,this),
              new JavaNamedType(getTypeAccess().buildAGNode(accessGraph)));

      JavaNodeKind kind;
        if(this.isAbstract())
            kind = JavaNodeKind.abstractMethod(methodAGType);
        else
            kind = JavaNodeKind.method(methodAGType);

      AGNode<JavaNodeKind> node = accessGraph.addNode(fullName(), name(), kind);

      accessGraph.registerDecl(node, this);

      return node;
	}

	public AGNode<JavaNodeKind> ConstructorDecl.buildAGNode(JavaAccessGraph accessGraph){
		
      MethodType constructorAGType = new MethodType(ASTNode.astParamsToAGType(accessGraph,this),
              new JavaNamedType(hostType().buildAGNode(accessGraph)));

      AGNode<JavaNodeKind> node = accessGraph.addNode(fullName(), name(),
      			JavaNodeKind.constructor(constructorAGType));

      accessGraph.registerDecl(node, this);
      return node;
	}

	

	public AGNode<JavaNodeKind> InstanceInitializer.buildAGNode(JavaAccessGraph accessGraph){
		return hostType().buildAGNode(accessGraph);
	}

	public AGNode<JavaNodeKind> StaticInitializer.buildAGNode(JavaAccessGraph accessGraph){
		return hostType().buildAGNode(accessGraph);
	}

	public AGNode<JavaNodeKind> VariableDeclaration.buildAGNode(JavaAccessGraph accessGraph){
		return hostBodyDecl().buildAGNode(accessGraph);
	}

	public AGNode<JavaNodeKind> ParameterDeclaration.buildAGNode(JavaAccessGraph accessGraph){
		return hostBodyDecl().buildAGNode(accessGraph);
	}

	interface TypeDeclared{
		TypeDecl getTypeDecl();
	}

	TypeAccess implements TypeDeclared;
	public TypeDecl TypeAccess.getTypeDecl(){
		return decl();
	}
	ParTypeAccess implements TypeDeclared;
	public TypeDecl ParTypeAccess.getTypeDecl(){
		return ((TypeAccess)getTypeAccess()).decl();
	}

	boolean TypeDecl.isFromStdLib(){
			return compilationUnit().packageName() == PRIMITIVE_PACKAGE_NAME ||
              compilationUnit().pathName().startsWith(System.getProperty("java.home"));
	}


	public ConstructorDecl TypeDecl.findConstructorBySignature(String paramsDescr){
		Collection<ConstructorDecl> ctrs = constructors();
		for(ConstructorDecl c : ctrs){
			if(c.getParametersAsString().equals(paramsDescr)){
				return c;
			}
		}
		return null;
	}
	

	//also present in jrrt-read-only/test/Testing.jrag
	public Program Frontend.getProgram() {
		return program;
	}
}